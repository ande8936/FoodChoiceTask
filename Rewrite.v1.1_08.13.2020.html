<!--
    v1.1
    8/13/2020
-->

<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <script src="jspsych-6.1.0/jspsych.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
        <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <style>img {width:300px;}</style>
        <meta charset="UTF-8">
    </head>
    <body></body>
    <script>
        //Declaring timeline variable containing all the stimulus items from the /img folder for use in all Trials.
        var test_stimuli = [
            { stimulus: 'img/LF_pic_01.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_01.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_02.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_02.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_03.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_03.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_04.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_04.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_05.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_05.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_06.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_06.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_07.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_07.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_08.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_08.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_09.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_09.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_10.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_10.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_11.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_11.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_12.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_12.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_13.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_13.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_14.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_14.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_15.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_15.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_16.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_16.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_17.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_17.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_18.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_18.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_19.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_19.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_20.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_20.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_21.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_21.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_22.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_22.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_23.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_23.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_24.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_24.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/LF_pic_25.png', data: {test_part: 'test', correct_response: '3'}},
            { stimulus: 'img/HF_pic_25.png', data: {test_part: 'test', correct_response: '3'}}
        ];

        //Declaring function to find the name of the reference file for use in Trial 3.
        function findReference() {
            var trueImages = jsPsych.data.get().filter({correct: true}).select('stimulus').values;
            trueImages.sort();
            for (i = 0; i < trueImages.length - 1; i++) {
                if (trueImages[i] === trueImages[i + 1]) {
                    return trueImages[i];
                }
            }
        }

        //Create Timeline
        var timeline = [];

        //Generate Random Subject ID with 15 Characters
        var subject_id = jsPsych.randomization.randomID(15);
        jsPsych.data.addProperties({ subject: subject_id });
        
        //Welcome Screen
        var welcome = {
            type: "html-keyboard-response",
            stimulus: "Welcome to today's experiment. Press any key to begin."
        };
        timeline.push(welcome);

        //Instructions: 3 timeline variables for each set of instructions corresponding to Trials 1-3.
        var instructions1 = {
            type: "html-keyboard-response",
            stimulus: "<h1>Module 1 Instructions</h1>" +
            "<p>Rate the following foods on how tasty they are, with 1 being BAD - Not Tasty and 5 being GOOD - Tasty.</p>" +
            "<p><strong>Press any button when ready to begin...</strong></p>",
        };
        timeline.push(instructions1);

        var test1 = {
  	        type: "image-keyboard-response",
  	        stimulus: jsPsych.timelineVariable('stimulus'),
            prompt: "<p>How HEALTHY is this food?</p>" +
            "<p>[Unhealthy] 1 -------- 2 ------- 3 ------- 4 ------- 5 [Healthy]</p>",
  	        choices: ['1', '2', '3', '4', '5'],
            labels: ['1 (BAD)', '3 (NEUTRAL)','5 (GOOD)'],
            data: jsPsych.timelineVariable('data'),
            on_finish: function(data) {
                data.correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(data.correct_response);
            },
	    }
        timeline.push({
            timeline: [test1],
            timeline_variables: test_stimuli,
            randomize_order: true,
            repetitions: 1,
        })

        var instructions2 = {
            type: "html-keyboard-response",
            stimulus: "<h1>Module 2 Instructions</h1>" +
                "<p>Rate the following foods on how HEALTHY they are, with 1 being the UNHEALTHY and 5 being HEALTHY.</p>" +
                "<p><strong>Press any key to begin.</strong></p>",
        };
        timeline.push(instructions2);

        var test2 = {
            type: "image-keyboard-response",
            stimulus: jsPsych.timelineVariable('stimulus'),
            prompt: "<p>How TASTY is this food?</p>" +
            "<p>[Not Tasty] 1 -------- 2 ------- 3 ------- 4 ------- 5 [Tasty]</p>",
            choices: ['1', '2', '3', '4', '5'],
            labels: ['1 (BAD)', '3 (NEUTRAL)','5 (GOOD)'],
            data: jsPsych.timelineVariable('data'),
            on_finish: function(data) {
                data.correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(data.correct_response);
            },
        }
        timeline.push({
            timeline: [test2],
            timeline_variables: test_stimuli,
            randomize_order: true,
            repetitions: 1,
        })

        var instructions3 = {
            type: "html-keyboard-response",
            stimulus: "<h1>Module 3 Instructions</h1>" +
                "<p>You will be presented with an image of a REFERENCE food item and an OTHER food item. Please indicate if you would PREFER to eat the OTHER food item instead of the REFERENCE food item, with 1 being NO, 3 being NEUTRAL and 5 being YES.</p>" +
                "<p><strong>Press any button when ready to begin...</strong></p>",
        };
        timeline.push(instructions3);

        var test3 = {
            type: "html-keyboard-response",
            stimulus: function() {
                return "<div style='float: left;'>" +
                    "<img src=" +
                    jsPsych.timelineVariable('stimulus',true) +
                    "></img>" +
                    "<p style='small'><strong>OTHER</strong></p></div>" +
                    "<div class='float: right;'>" +
                    "<img src=" +
                    findReference() +
                    "></img>" +
                    "<p style='small'><strong>REFERENCE</strong></p></div>"
            },
            prompt:
            "<p><center>Would you rather have the OTHER food item instead of the REFERENCE food item?</center></p>" +
            "<p><center>[NO] 1 -------- 2 ------- 3 ------- 4 ------- 5 [YES]</center></p>",
            choices: ['1', '2', '3', '4', '5'],
            labels: ["1 (NO)", "3 (NEUTRAL)", "5 (YES)"],
            data: jsPsych.timelineVariable('data'),
        }
        timeline.push({
            timeline: [test3],
            timeline_variables: test_stimuli,
            randomize_order: true,
            repetitions: 1,
        })

        //Initializes Timeline with all blocks therein as defined by test_procedure
        jsPsych.init ({
            timeline: timeline,
            on_finish: function() {
                var content = "data:text/csv;charset:utf-8," + jsPsych.data.get().json();
                outputfile = "food_choice_trial" + generateFileName('.json')
                var link = document.createElement("a");
                link.setAttribute("href",encodeURI(content));
                link.setAttribute("download",outputfile);
                document.body.appendChild(link);
                link.click();
            }
        });

        //Same function as in original code, dictating details of output file name
        function generateFileName(suffix) {
            var k = 0;
            var today = new Date();
            datenow = today.getFullYear().toString() +
            '_' + (today.getMonth()+1).toString() +
            '_' + today.getDate().toString() +
            '_' + today.getHours().toString() +
            '_' + today.getMinutes().toString() +
            '_' + today.getSeconds().toString();
            return datenow + suffix;
        }
    </script>
</html>